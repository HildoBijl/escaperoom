// firestore.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isNonEmptyString(x, min, max) {
      return x is string && x.size() >= min && x.size() <= max;
    }

    function isValidAge(a) {
      return a is int && a >= 6 && a <= 120;
    }

    function isValidEmail(e) {
      return e is string && e.matches('^[^\\s@]+@[^\\s@]+\\.[^\\s@]{2,}$');
    }

    // For eligibilityGroup (6/7/8)
    function isValidEligibilityGroup(g) {
      return g is int && (g == 6 || g == 7 || g == 8);
    }

    // NL postcode: "1234 AB" or "1234AB"
    function isValidNLPostcode(p) {
      return p is string && p.upper().matches('^[1-9][0-9]{3}\\s?[A-Z]{2}$');
    }

    function isValidCampPreference(v) {
      return v is string && (v == "A1" || v == "A2" || v == "geen");
    }

    // geboortedatum as "YYYY-MM-DD" (basic format validation)
    function isValidBirthdate(b) {
      return b is string && b.matches('^\\d{4}-\\d{2}-\\d{2}$');
    }

    // ----------------------------
    // Kamp A: PUBLIC leaderboard
    // ----------------------------
    match /leaderbord-kamp-a/{docId} {
      allow read, list: if true;

      allow create: if
        request.resource.data.keys().hasOnly([
          "name", "age", "createdAt"
        ]) &&
        isNonEmptyString(request.resource.data.name, 1, 60) &&
        isValidAge(request.resource.data.age) &&
        (request.resource.data.createdAt is timestamp);

      allow update, delete: if false;
    }

    // ----------------------------
    // Kamp A: PRIVATE prizes (PII)
    // ----------------------------
    match /prizes-kamp-a/{docId} {
      // do NOT allow client reads
      allow read, list: if false;

      allow create: if
        request.resource.data.keys().hasOnly([
          // required (*)
          "firstName",
          "lastName",
          "address",
          "postcode",
          "city",
          "email",
          "phone",
          "birthdate",
          "groupText",
          "school",
          "campPreference",

          // optional
          "gender",

          // kept restriction fields
          "age",
          "eligibilityGroup",
          "beenBefore",
          "parentsPhone",
          "createdAt"
        ]) &&

        // required strings
        isNonEmptyString(request.resource.data.firstName, 1, 60) &&
        isNonEmptyString(request.resource.data.lastName, 1, 80) &&
        isNonEmptyString(request.resource.data.address, 3, 120) &&
        isValidNLPostcode(request.resource.data.postcode) &&
        isNonEmptyString(request.resource.data.city, 1, 80) &&
        isValidEmail(request.resource.data.email) &&
        isNonEmptyString(request.resource.data.phone, 6, 32) &&

        // geboortedatum + school + group text + camp pref
        isValidBirthdate(request.resource.data.birthdate) &&
        isNonEmptyString(request.resource.data.groupText, 1, 24) &&
        isNonEmptyString(request.resource.data.school, 1, 120) &&
        isValidCampPreference(request.resource.data.campPreference) &&

        // optional gender (if present, must be a reasonable string)
        (
          !("gender" in request.resource.data) ||
          request.resource.data.gender == null ||
          isNonEmptyString(request.resource.data.gender, 1, 40)
        ) &&

        // kept restrictions
        isValidAge(request.resource.data.age) &&
        isValidEligibilityGroup(request.resource.data.eligibilityGroup) &&
        (request.resource.data.beenBefore is bool) &&
        isNonEmptyString(request.resource.data.parentsPhone, 6, 32) &&
        (request.resource.data.createdAt is timestamp);

      allow update, delete: if false;
    }

    // ----------------------------
    // Telemetry: Bug Reports
    // ----------------------------
    match /telemetry-bug-reports/{docId} {
      allow read, list: if false;

      allow create: if
        request.resource.data.keys().hasOnly([
          "description", "currentScene", "sessionId",
          "deviceInfo", "registrySnapshot", "createdAt"
        ]) &&
        request.resource.data.description is string &&
        request.resource.data.description.size() <= 2000 &&
        request.resource.data.sessionId is string &&
        request.resource.data.createdAt is timestamp;

      allow update, delete: if false;
    }

    // ----------------------------
    // Telemetry: Error Logs
    // ----------------------------
    match /telemetry-errors/{docId} {
      allow read, list: if false;

      allow create: if
        request.resource.data.keys().hasOnly([
          "message", "stack", "type", "currentScene",
          "sessionId", "deviceInfo", "url", "createdAt"
        ]) &&
        request.resource.data.message is string &&
        request.resource.data.message.size() <= 500 &&
        request.resource.data.sessionId is string &&
        request.resource.data.createdAt is timestamp;

      allow update, delete: if false;
    }

    // ----------------------------
    // Telemetry: Analytics
    // ----------------------------
    match /telemetry-analytics/{docId} {
      allow read, list: if false;

      allow create: if
        request.resource.data.keys().hasOnly([
          "sessionId", "playerId", "deviceInfo", "events", "createdAt"
        ]) &&
        request.resource.data.sessionId is string &&
        request.resource.data.playerId is string &&
        request.resource.data.events is list &&
        request.resource.data.createdAt is timestamp;

      allow update, delete: if false;
    }

    // ----------------------------
    // Telemetry: Budget Counter
    // ----------------------------
    match /telemetry-meta/{docId} {
      allow read: if true;

      allow create, update: if
        request.resource.data.keys().hasOnly(["date", "count"]) &&
        request.resource.data.date is string &&
        request.resource.data.count is int;

      allow delete: if false;
    }
  }
}
